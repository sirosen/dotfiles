#!/usr/bin/env python
"""
Convert ReST and sphinx-issues syntaxes to GitHub-flavored Markdown, and print the
results.

Takes the changelog data from stdin.
"""

import re
import typing as t

H2_RST_PATTERN = re.compile(r"=+")
H3_RST_PATTERN = re.compile(r"-+")

SPHINX_ISSUES_PR_PATTERN = re.compile(r":pr:`(\d+)`")
SPHINX_ISSUES_ISSUE_PATTERN = re.compile(r":issue:`(\d+)`")
SPHINX_ISSUES_USER_PATTERN = re.compile(r":user:`([^`]+)`")
LINK_PATTERN = re.compile(r"`([^<]+) <([^>]+)>`_")
INLINE_CODE_PATTERN = re.compile(r"``([^`]+)``")


def convert_rst_to_md(lines: list[str]) -> t.Iterator[str]:
    skip = False
    for i, line in enumerate(lines):
        if skip:
            skip = False
            continue

        try:
            peek = lines[i + 1]
        except IndexError:
            peek = None

        updated = line

        if peek is not None and H3_RST_PATTERN.fullmatch(peek):
            skip = True
            updated = f"## {updated}"

        updated = SPHINX_ISSUES_PR_PATTERN.sub(r"#\1", updated)
        updated = SPHINX_ISSUES_ISSUE_PATTERN.sub(r"#\1", updated)
        updated = SPHINX_ISSUES_USER_PATTERN.sub(r"@\1", updated)
        updated = LINK_PATTERN.sub(r"[\1](\2)", updated)
        updated = INLINE_CODE_PATTERN.sub(r"`\1`", updated)
        yield updated


def main():
    import sys

    changelog_section = sys.stdin.readlines()

    for line in convert_rst_to_md(changelog_section):
        print(line, end="")


if __name__ == "__main__":
    main()
